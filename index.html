<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Street Name Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #map {
      flex: 1 1 60%;
      min-height: 300px;
    }
    #quiz {
      flex: 1 1 40%;
      padding: 16px;
      background: #f9f9f9;
      overflow-y: auto;
    }
    .street-question {
      margin-bottom: 12px;
    }
    .correct {
      color: green;
      font-weight: bold;
    }
    .incorrect {
      color: red;
      font-weight: bold;
    }
    #start-quiz-btn, #reset-btn {
      margin: 8px 0;
      padding: 8px 16px;
      font-size: 1rem;
      cursor: pointer;
    }
    #instructions {
      margin-bottom: 12px;
      color: #333;
    }
    .quiz-marker {
      background: #1976d2;
      color: #fff;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      border: 2px solid #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
  </style>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <div id="app">
    <div id="map"></div>
    <div id="quiz">
      <div id="instructions">
        <b>Instructions:</b> <br>
        1. Pan and zoom the map to your desired area.<br>
        2. Click "Start Quiz" to load visible street names.<br>
        3. Fill in the street names as a quiz.<br>
      </div>
      <button id="start-quiz-btn">Start Quiz</button>
      <button id="reset-btn" style="display:none;">Reset</button>
      <form id="quiz-form" style="display:none;"></form>
      <div id="results"></div>
    </div>
  </div>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Helper: fetch street names using Overpass API
    async function fetchStreetNames(bounds) {
      // bounds: Leaflet LatLngBounds
      const sw = bounds.getSouthWest();
      const ne = bounds.getNorthEast();
      
      console.log("Fetching streets for bounds:", sw, ne);
      
      // Sample Raleigh street data with coordinates covering all of Raleigh
      const allSampleStreets = [
        // Downtown Raleigh
        { name: "Fayetteville St", lat: 35.7796, lng: -78.6382 },
        { name: "Hillsborough St", lat: 35.7844, lng: -78.6581 },
        { name: "Glenwood Ave", lat: 35.7891, lng: -78.6478 },
        { name: "Blount St", lat: 35.7778, lng: -78.6401 },
        { name: "Person St", lat: 35.7856, lng: -78.6334 },
        { name: "Dawson St", lat: 35.7789, lng: -78.6412 },
        { name: "Wilmington St", lat: 35.7801, lng: -78.6367 },
        { name: "Salisbury St", lat: 35.7791, lng: -78.6395 },
        { name: "Hargett St", lat: 35.7781, lng: -78.6389 },
        { name: "Martin St", lat: 35.7771, lng: -78.6405 },
        { name: "Edenton St", lat: 35.7761, lng: -78.6395 },
        { name: "Jones St", lat: 35.7751, lng: -78.6401 },
        { name: "Lenoir St", lat: 35.7741, lng: -78.6411 },
        { name: "Morgan St", lat: 35.7731, lng: -78.6421 },
        { name: "South St", lat: 35.7721, lng: -78.6431 },
        { name: "Capitol Blvd", lat: 35.7806, lng: -78.6392 },
        { name: "McDowell St", lat: 35.7816, lng: -78.6402 },
        { name: "Harrington St", lat: 35.7826, lng: -78.6412 },
        { name: "Bloodworth St", lat: 35.7836, lng: -78.6422 },
        { name: "East St", lat: 35.7846, lng: -78.6432 },
        
        // North Raleigh
        { name: "Six Forks Rd", lat: 35.8500, lng: -78.6500 },
        { name: "Falls of Neuse Rd", lat: 35.8600, lng: -78.6400 },
        { name: "Creedmoor Rd", lat: 35.8400, lng: -78.6600 },
        { name: "Glenwood Ave", lat: 35.8200, lng: -78.6800 },
        { name: "Lead Mine Rd", lat: 35.8300, lng: -78.6700 },
        { name: "Strickland Rd", lat: 35.8700, lng: -78.6300 },
        { name: "Spring Forest Rd", lat: 35.8800, lng: -78.6200 },
        { name: "Lynn Rd", lat: 35.8500, lng: -78.6800 },
        { name: "Sawmill Rd", lat: 35.8400, lng: -78.6900 },
        { name: "Durant Rd", lat: 35.8900, lng: -78.6100 },
        
        // South Raleigh
        { name: "South Saunders St", lat: 35.7500, lng: -78.6400 },
        { name: "Wilmington St", lat: 35.7600, lng: -78.6500 },
        { name: "New Bern Ave", lat: 35.7700, lng: -78.6200 },
        { name: "Lake Wheeler Rd", lat: 35.7200, lng: -78.6600 },
        { name: "Tryon Rd", lat: 35.7400, lng: -78.6800 },
        { name: "Rocky Mount Rd", lat: 35.7300, lng: -78.7000 },
        { name: "Ten Ten Rd", lat: 35.7100, lng: -78.7200 },
        { name: "Buffaloe Rd", lat: 35.7500, lng: -78.7200 },
        { name: "Jones Sausage Rd", lat: 35.7400, lng: -78.7400 },
        { name: "Sunnybrook Rd", lat: 35.7600, lng: -78.7600 },
        
        // East Raleigh
        { name: "New Hope Rd", lat: 35.7800, lng: -78.5800 },
        { name: "Buffalo Rd", lat: 35.7900, lng: -78.5600 },
        { name: "Hodge Rd", lat: 35.8000, lng: -78.5400 },
        { name: "Forestville Rd", lat: 35.8100, lng: -78.5200 },
        { name: "Miami Blvd", lat: 35.8200, lng: -78.5000 },
        { name: "Brentwood Rd", lat: 35.7700, lng: -78.6000 },
        { name: "Trawick Rd", lat: 35.7600, lng: -78.5800 },
        { name: "Rogers Ln", lat: 35.7500, lng: -78.5600 },
        { name: "Poole Rd", lat: 35.7400, lng: -78.5400 },
        { name: "Hammond Rd", lat: 35.7300, lng: -78.5200 },
        
        // West Raleigh
        { name: "Western Blvd", lat: 35.7800, lng: -78.7000 },
        { name: "Avent Ferry Rd", lat: 35.7900, lng: -78.7200 },
        { name: "Gorman St", lat: 35.8000, lng: -78.7400 },
        { name: "Blue Ridge Rd", lat: 35.8100, lng: -78.7600 },
        { name: "Durham Rd", lat: 35.8200, lng: -78.7800 },
        { name: "Beryl Rd", lat: 35.7700, lng: -78.7200 },
        { name: "Avent Ferry Rd", lat: 35.7600, lng: -78.7400 },
        { name: "Method Rd", lat: 35.7500, lng: -78.7600 },
        { name: "Pullen Rd", lat: 35.7400, lng: -78.7800 },
        { name: "Dan Allen Dr", lat: 35.7300, lng: -78.8000 },
        
        // Northwest Raleigh
        { name: "Brier Creek Pkwy", lat: 35.9000, lng: -78.7800 },
        { name: "Leesville Rd", lat: 35.8800, lng: -78.7600 },
        { name: "Norwood Rd", lat: 35.8600, lng: -78.7400 },
        { name: "Litchford Rd", lat: 35.8400, lng: -78.7200 },
        { name: "Millbrook Rd", lat: 35.8200, lng: -78.7000 },
        { name: "Atlantic Ave", lat: 35.8000, lng: -78.6800 },
        { name: "Wake Forest Rd", lat: 35.7800, lng: -78.6600 },
        { name: "Capital Blvd", lat: 35.7600, lng: -78.6400 },
        { name: "Raleigh Blvd", lat: 35.7400, lng: -78.6200 },
        { name: "New Hope Church Rd", lat: 35.7200, lng: -78.6000 },
        
        // Southeast Raleigh
        { name: "Rock Quarry Rd", lat: 35.7000, lng: -78.6000 },
        { name: "Martin Luther King Jr Blvd", lat: 35.7200, lng: -78.5800 },
        { name: "Hammond Rd", lat: 35.7400, lng: -78.5600 },
        { name: "Buffalo Rd", lat: 35.7600, lng: -78.5400 },
        { name: "New Hope Rd", lat: 35.7800, lng: -78.5200 },
        { name: "Hodge Rd", lat: 35.8000, lng: -78.5000 },
        { name: "Forestville Rd", lat: 35.8200, lng: -78.4800 },
        { name: "Miami Blvd", lat: 35.8400, lng: -78.4600 },
        { name: "Brentwood Rd", lat: 35.8600, lng: -78.4400 },
        { name: "Trawick Rd", lat: 35.8800, lng: -78.4200 }
      ];
      
      // Filter streets that are within the current map bounds
      const visibleStreets = allSampleStreets.filter(street => {
        return street.lat >= sw.lat && street.lat <= ne.lat && 
               street.lng >= sw.lng && street.lng <= ne.lng;
      });
      
      console.log(`Found ${visibleStreets.length} streets in current view out of ${allSampleStreets.length} total`);
      console.log("Visible streets:", visibleStreets.map(s => s.name));
      
      return visibleStreets;
    }

    let map;
    let quizStreets = [];
    let markers = [];
    let quizStarted = false;
    let originalTileLayer;

    function clearMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
    }

    function showMarkersForQuiz(streets) {
      clearMarkers();
      streets.forEach((street, idx) => {
        const marker = L.marker([street.lat, street.lng], {
          icon: L.divIcon({
            className: 'quiz-marker',
            html: String(idx + 1),
            iconSize: [24, 24],
            iconAnchor: [12, 12]
          })
        }).addTo(map);
        markers.push(marker);
      });
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function startQuiz(streets) {
      quizStarted = true;
      document.getElementById('start-quiz-btn').style.display = 'none';
      document.getElementById('reset-btn').style.display = '';
      document.getElementById('quiz-form').style.display = '';
      document.getElementById('results').innerHTML = '';
      
      // Switch to a tile layer without street names
      map.removeLayer(originalTileLayer);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd'
      }).addTo(map);
      
      // Shuffle and limit to 8 streets for quiz
      shuffleArray(streets);
      quizStreets = streets.slice(0, 8);
      showMarkersForQuiz(quizStreets);

      // Build quiz form
      const form = document.getElementById('quiz-form');
      form.innerHTML = '';
      quizStreets.forEach((street, idx) => {
        const div = document.createElement('div');
        div.className = 'street-question';
        div.innerHTML = `
          <label>
            <b>Street #${idx + 1}:</b>
            <input type="text" name="street${idx}" autocomplete="off" required>
          </label>
        `;
        form.appendChild(div);
      });
      const submitBtn = document.createElement('button');
      submitBtn.type = 'submit';
      submitBtn.textContent = 'Submit Answers';
      submitBtn.style.marginTop = '12px';
      form.appendChild(submitBtn);
    }

    function showResults(userAnswers) {
      const resultsDiv = document.getElementById('results');
      let correct = 0;
      let html = '<h3>Results:</h3><ol>';
      quizStreets.forEach((street, idx) => {
        const user = (userAnswers[idx] || '').trim();
        const answer = street.name;
        if (user.toLowerCase() === answer.toLowerCase()) {
          html += `<li><span class="correct">✔ ${answer}</span></li>`;
          correct++;
        } else {
          html += `<li><span class="incorrect">✘ ${user || '(blank)'}</span> <span style="color:#888;">(Correct: ${answer})</span></li>`;
        }
      });
      html += '</ol>';
      html += `<b>Score: ${correct} / ${quizStreets.length}</b>`;
      resultsDiv.innerHTML = html;
    }

    function resetQuiz() {
      quizStarted = false;
      document.getElementById('start-quiz-btn').style.display = '';
      document.getElementById('reset-btn').style.display = 'none';
      document.getElementById('quiz-form').style.display = 'none';
      document.getElementById('results').innerHTML = '';
      clearMarkers();
      
      // Restore original tile layer with street names
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer) {
          map.removeLayer(layer);
        }
      });
      originalTileLayer.addTo(map);
    }

    window.onload = function() {
      // Default: Downtown Raleigh, NC
      map = L.map('map').setView([35.7796, -78.6382], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // Store reference to the original tile layer
      originalTileLayer = map._layers[Object.keys(map._layers)[0]];

      document.getElementById('start-quiz-btn').onclick = async function() {
        document.getElementById('start-quiz-btn').disabled = true;
        document.getElementById('start-quiz-btn').textContent = 'Loading...';
        const bounds = map.getBounds();
        if (!bounds) {
          alert("Please wait for the map to load.");
          document.getElementById('start-quiz-btn').disabled = false;
          document.getElementById('start-quiz-btn').textContent = 'Start Quiz';
          return;
        }
        try {
          const streets = await fetchStreetNames(bounds);
          if (streets.length < 3) {
            alert("Not enough streets found in this area. Please zoom out or move the map.");
            document.getElementById('start-quiz-btn').disabled = false;
            document.getElementById('start-quiz-btn').textContent = 'Start Quiz';
            return;
          }
          startQuiz(streets);
        } catch (e) {
          console.error("Error details:", e);
          alert(`Failed to fetch street data: ${e.message}. Check console for details.`);
        }
        document.getElementById('start-quiz-btn').disabled = false;
        document.getElementById('start-quiz-btn').textContent = 'Start Quiz';
      };

      document.getElementById('reset-btn').onclick = resetQuiz;

      document.getElementById('quiz-form').onsubmit = function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const userAnswers = [];
        for (let i = 0; i < quizStreets.length; i++) {
          userAnswers.push(formData.get('street' + i));
        }
        showResults(userAnswers);
      };
    };
  </script>
</body>
</html>

